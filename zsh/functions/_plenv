#compdef plenv

typeset -A opt_args
local context state line

_arguments -C \
  '1: :->cmds' \
  '*: :->args' && ret=0


case $state in
  cmds)
    local -a cmds
    cmds=(help available install exec global local rehash install-cpanm migrate-modules which)
    _describe -t commands 'perlbrew command' cmds && ret=0
#           plenv help
#           plenv available
#           plenv install 5.16.2
#           plenv exec ack
#           plenv global 5.16.2
#           plenv local 5.14.0
#           plenv rehash
#           plenv install-cpanm
#           plenv migrate-modules 5.8.9 5.16.2
#           plenv which cpanm
    ;;
  args)
    case $line[1] in
      global | local )
        local -a versions
        versions=($(perlbrew list | perl -pe 's/^\*//m;s/\n/ /m'))
        _wanted versions expl 'perl version' compadd $versions && ret=0 
        ;;
      install)
        local -a perl_versions
        perl_versions=($(plenv available|perl -pe 's/^i//m;s/\n/ /m'))
        _wanted perl_versions expl 'perl-<version-number>' compadd $perl_versions && ret=0 
        ;;
      exec)
        # words=(perbrew exec),  CURRENT=2 が渡るのでwordsを空にして、カーソルを2戻す
        shift 2 words
        (( CURRENT-- ))
        (( CURRENT-- ))
        _normal && ret=0
        ;;
      *)
        (( ret )) && _message 'no more arguments'
        ;;
    esac
    ;;
esac

return ret

# vim: et sw=2 ts=2 si
